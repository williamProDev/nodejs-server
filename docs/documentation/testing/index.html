<!DOCTYPE html><html class="initial"><head><title>Testing documentation - server.js</title><meta property="og:title" content="Testing documentation - server.js"/><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="keywords" content="server, javascript, js, node.js, library, html, html5, express"><meta name="description" content="Testing your application properly."/><meta property="og:description" content="Testing your application properly."/><link rel="shortcut icon" type="image/png" href="/img/logo.png"><meta property="og:url" content="http://serverjs.io/"><meta property="og:image" content="https://serverjs.io/img/logo.png"><link href="/assets/style.min.css" rel="stylesheet"></head><body id="top"><div class="width-1100"></div><nav><a class="brand" href="/"><img class="logo" src="/img/logo.svg" alt="logo"><span class="text">server.js</span></a><input class="show" id="bmenu" type="checkbox"><label class="burger pseudo button switch" for="bmenu">menu</label><div class="menu"><a class="pseudo button" href="https://medium.com/server-for-node-js" target="_blank">Blog</a><a class="pseudo button" href="https://github.com/franciscop/server" target="_blank">Github</a><a class="pseudo button" href="/tutorials">Tutorials</a><a class="button" href="/documentation">Documentation</a></div></nav><article class="documentation"><div class="flex"><section class="toc"><h2><a href="/documentation/">Documentation</a></h2><ul><li><label class="more"></label><a class="good" href="/documentation/">Introduction</a><ul><li><a class="good" href="/documentation/#getting-started">Getting Started</a></li><li><a class="good" href="/documentation/#basic-usage">Basic usage</a></li><li><a class="good" href="/documentation/#middleware">Middleware</a></li><li><a class="good" href="/documentation/#express-middleware">Express middleware</a></li><li><a class="good" href="/documentation/#routing">Routing</a></li><li><a class="mid" href="/documentation/#advanced-topics">Advanced topics</a></li></ul></li><li><label class="more"></label><a class="good" href="/documentation/options/">Options</a><ul><li><a class="good" href="/documentation/options/#port">port</a></li><li><a class="good" href="/documentation/options/#secret">secret</a></li><li><a class="good" href="/documentation/options/#public">public</a></li><li><a class="good" href="/documentation/options/#views">views</a></li><li><a class="good" href="/documentation/options/#engine">engine</a></li><li><a class="good" href="/documentation/options/#env">env</a></li><li><a class="good" href="/documentation/options/#favicon">favicon</a></li><li><a class="good" href="/documentation/options/#log">log</a></li><li><a class="good" href="/documentation/options/#session">session</a></li><li><a class="mid" href="/documentation/options/#security">security</a></li></ul></li><li><label class="more"></label><a class="good" href="/documentation/context/">Context</a><ul><li><a class="good" href="/documentation/context/#-options">.options</a></li><li><a class="good" href="/documentation/context/#-data">.data</a></li><li><a class="good" href="/documentation/context/#-params">.params</a></li><li><a class="good" href="/documentation/context/#-query">.query</a></li><li><a class="good" href="/documentation/context/#-session">.session</a></li><li><a class="good" href="/documentation/context/#-headers">.headers</a></li><li><a class="good" href="/documentation/context/#-cookie">.cookie</a></li><li><a class="good" href="/documentation/context/#-files">.files</a></li><li><a class="good" href="/documentation/context/#-ip">.ip</a></li><li><a class="good" href="/documentation/context/#-url">.url</a></li><li><a class="good" href="/documentation/context/#-method">.method</a></li><li><a class="good" href="/documentation/context/#-path">.path</a></li><li><a class="good" href="/documentation/context/#-secure">.secure</a></li><li><a class="good" href="/documentation/context/#-xhr">.xhr</a></li></ul></li><li><label class="more"></label><a class="good" href="/documentation/router/">Router</a><ul class="size-100"><li><a class="good" href="/documentation/router/#get-">get()</a></li><li><a class="good" href="/documentation/router/#post-">post()</a></li><li><a class="good" href="/documentation/router/#put-">put()</a></li><li><a class="good" href="/documentation/router/#del-">del()</a></li><li><a class="good" href="/documentation/router/#error-">error()</a></li><li><a class="good" href="/documentation/router/#sub-">sub()</a></li></ul></li><li><label class="more"></label><a class="good" href="/documentation/reply/">Reply</a><ul><li><a class="good" href="/documentation/reply/#cookie-">cookie()</a></li><li><a class="good" href="/documentation/reply/#download-">download()</a></li><li><a class="good" href="/documentation/reply/#header-">header()</a></li><li><a class="good" href="/documentation/reply/#json-">json()</a></li><li><a class="good" href="/documentation/reply/#jsonp-">jsonp()</a></li><li><a class="good" href="/documentation/reply/#redirect-">redirect()</a></li><li><a class="good" href="/documentation/reply/#render-">render()</a></li><li><a class="good" href="/documentation/reply/#send-">send()</a></li><li><a class="good" href="/documentation/reply/#status-">status()</a></li><li><a class="good" href="/documentation/reply/#type-">type()</a></li></ul></li><li><label class="more"></label><a class="mid" href="/documentation/errors/">Errors</a><ul><li><a class="bad" href="/documentation/errors/#native">/server/native</a></li><li><a class="bad" href="/documentation/errors/#core">/server/core</a></li><li><a class="bad" href="/documentation/errors/#options">/server/options</a></li></ul></li><li><label class="more"></label><a class="mid" href="/documentation/testing/">Testing</a><ul><li><a class="bad" href="/documentation/testing/#setup">Setup</a></li><li><a class="bad" href="/documentation/testing/#unit">Unit</a></li><li><a class="bad" href="/documentation/testing/#integration">Integration</a></li></ul></li></ul></section><div class="main"><h1 id="testing">Testing</h1>
<p>There&#39;s a small test suite included, but you probably want to use something more specific to your use-case.</p>
<p>Testing that a middleware correctly handles the lack of a user:</p>
<pre><code class="lang-js">// auth/errors.js (more info in /documentation/errors/)
const error = require(&#39;server/error&#39;);
error[&#39;/app/auth/nouser&#39;] = &#39;You must be authenticated to do this&#39;;
module.exports = error;
</code></pre>
<p>Our main module:</p>
<pre><code class="lang-js">// auth/needuser.js
const AuthError = require(&#39;./errors&#39;);

module.exports = ctx =&gt; {
  if (!ctx.user) {
    throw new AuthError(&#39;/app/auth/nouser&#39;, { status: 403, public: true });
  }
};
</code></pre>
<p>Then to test this module:</p>
<pre><code class="lang-js">// auth/needuser.test.js
const run = require(&#39;server/test/run&#39;);
const needuser = require(&#39;./needuser&#39;);

describe(&#39;auth/needuser.js&#39;, () =&gt; {
  it(&#39;returns a server error without a user&#39;, async () =&gt; {
    const res = await run(needuser).get(&#39;/&#39;);
    expect(res.status).toBe(403);
  });

  it(&#39;works with a mocked user&#39;, async () =&gt; {
    const mockuser = ctx =&gt; { ctx.user = {}; };
    const res = await run(mockuser, needuser).get(&#39;/&#39;);
    expect(res.status).toBe(200);
  });
});
</code></pre>
<h2 id="run-">run()</h2>
<p>This function accepts the same arguments as <code>server()</code>, however it will return an API that you can use to test any middleware (and, by extension, any route) that you want. The API that it returns so far is this:</p>
<pre><code class="lang-js">const run = require(&#39;server/test/run&#39;);

const api = run(TOTEST);

api.get.then(res =&gt; { ... });
api.post.then(res =&gt; { ... });
api.put.then(res =&gt; { ... });
api.del.then(res =&gt; { ... });
</code></pre>
<h2 id="disable-csrf">Disable CSRF</h2>
<p>For testing POST, PUT and DELETE methods you might want to disable CSRF. To do that, just pass it the appropriate option:</p>
<pre><code class="lang-js">run({ security: { csrf: false } }, TOTEST);
</code></pre>
<p>This API accepts as arguments:</p>
<pre><code class="lang-js">api.get(URL, OPTIONS);
</code></pre>
<p>It is using <a href="https://github.com/request/request"><code>request</code></a> underneath, so the options are the same as for this module. There are few small differences:</p>
<ul>
<li>It will generate the port randomly from <a href="https://stackoverflow.com/q/413807/938236">1024</a> to <a href="https://stackoverflow.com/a/113237/938236">49151</a>. However, there is a chance of collision that grows <a href="https://en.wikipedia.org/wiki/Birthday_problem">faster than expected</a> as your number of tests grows. There&#39;s mitigation code going on to avoid collisions so until the tens of thousands of tests it should be fine.</li>
<li>The URLs will be made local internally to <code>http://localhost:${port}</code> unless you fully qualify them (which is not recommended).</li>
</ul>
<h2 id="keep-reading">Keep reading</h2><p>List of all the topics:</p><div class="pages"><a class="button" href="/documentation/options">Options</a><a class="button" href="/documentation/context">Context</a><a class="button" href="/documentation/router">Router</a><a class="button" href="/documentation/reply">Reply</a><a class="button" href="/documentation/errors">Errors</a><a class="button" href="/documentation/testing">Testing</a></div></div></div></article><script src="https://unpkg.com/smoothscroll-polyfill@0.4.0/dist/smoothscroll.js"></script><script>/* Umbrella JS 2.8.0 umbrellajs.com */
function ajax(a,b,c,d){c=c||function(){},b=b||{},b.body=b.body||{},b.method=(b.method||"GET").toUpperCase(),b.headers=b.headers||{},b.headers["X-Requested-With"]=b.headers["X-Requested-With"]||"XMLHttpRequest","undefined"!=typeof window.FormData&&b.body instanceof window.FormData||(b.headers["Content-Type"]=b.headers["Content-Type"]||"application/x-www-form-urlencoded"),/json/.test(b.headers["Content-Type"])&&(b.body=JSON.stringify(b.body)),"object"!=typeof b.body||b.body instanceof window.FormData||(b.body=u().param(b.body));var e=new window.XMLHttpRequest;u(e).on("error timeout abort",function(){c(new Error,null,e)}).on("load",function(){var a=/^(4|5)/.test(e.status)?new Error(e.status):null,b=parseJson(e.response)||e.response;return c(a,b,e)}),e.open(b.method,a),e.withCredentials=!0;for(var f in b.headers)e.setRequestHeader(f,b.headers[f]);return d&&d(e),e.send(b.body),e}function parseJson(a){try{var b=JSON.parse(a);if(b&&"object"==typeof b)return b}catch(c){}return!1}var u=function(a,b){return this instanceof u?a instanceof u?a:("string"==typeof a&&(a=this.select(a,b)),a&&a.nodeName&&(a=[a]),void(this.nodes=this.slice(a))):new u(a,b)};u.prototype={get length(){return this.nodes.length}},u.prototype.nodes=[],u.prototype.addClass=function(){return this.eacharg(arguments,function(a,b){a.classList.add(b)})},u.prototype.adjacent=function(a,b,c){return"number"==typeof b&&(b=0===b?[]:new Array(b).join().split(",").map(Number.call,Number)),this.each(function(d,e){var f=document.createDocumentFragment();u(b||{}).map(function(b,c){var f="function"==typeof a?a.call(this,b,c,d,e):a;return"string"==typeof f?this.generate(f):u(f)}).each(function(a){this.isInPage(a)?f.appendChild(u(a).clone().first()):f.appendChild(a)}),c.call(this,d,f)})},u.prototype.after=function(a,b){return this.adjacent(a,b,function(a,b){a.parentNode.insertBefore(b,a.nextSibling)})},u.prototype.ajax=function(a,b){return this.handle("submit",function(c){ajax(u(this).attr("action"),{body:u(this).serialize(),method:u(this).attr("method")},a&&a.bind(this),b&&b.bind(this))})},u.prototype.append=function(a,b){return this.adjacent(a,b,function(a,b){a.appendChild(b)})},u.prototype.args=function(a,b,c){return"function"==typeof a&&(a=a(b,c)),"string"!=typeof a&&(a=this.slice(a).map(this.str(b,c))),a.toString().split(/[\s,]+/).filter(function(a){return a.length})},u.prototype.array=function(a){a=a;var b=this;return this.nodes.reduce(function(c,d,e){var f;return a?(f=a.call(b,d,e),f||(f=!1),"string"==typeof f&&(f=u(f)),f instanceof u&&(f=f.nodes)):f=d.innerHTML,c.concat(f!==!1?f:[])},[])},u.prototype.attr=function(a,b,c){if(c=c?"data-":"",void 0!==b){var d=a;a={},a[d]=b}return"object"==typeof a?this.each(function(b){for(var d in a)b.setAttribute(c+d,a[d])}):this.length?this.first().getAttribute(c+a):""},u.prototype.before=function(a,b){return this.adjacent(a,b,function(a,b){a.parentNode.insertBefore(b,a)})},u.prototype.children=function(a){return this.map(function(a){return this.slice(a.children)}).filter(a)},u.prototype.clone=function(){return this.map(function(a,b){var c=a.cloneNode(!0),d=this.getAll(c);return this.getAll(a).each(function(a,b){for(var c in this.mirror)this.mirror[c](a,d.nodes[b])}),c})},u.prototype.getAll=function(a){return u([a].concat(u("*",a).nodes))},u.prototype.mirror={},u.prototype.mirror.events=function(a,b){if(a._e)for(var c in a._e)a._e[c].forEach(function(a){u(b).on(c,a)})},u.prototype.mirror.select=function(a,b){u(a).is("select")&&(b.value=a.value)},u.prototype.mirror.textarea=function(a,b){u(a).is("textarea")&&(b.value=a.value)},u.prototype.closest=function(a){return this.map(function(b){do if(u(b).is(a))return b;while((b=b.parentNode)&&b!==document)})},u.prototype.data=function(a,b){return this.attr(a,b,!0)},u.prototype.each=function(a){return this.nodes.forEach(a.bind(this)),this},u.prototype.eacharg=function(a,b){return this.each(function(c,d){this.args(a,c,d).forEach(function(a){b.call(this,c,a)},this)})},u.prototype.empty=function(){return this.each(function(a){for(;a.firstChild;)a.removeChild(a.firstChild)})},u.prototype.filter=function(a){var b=function(b){return b.matches=b.matches||b.msMatchesSelector||b.webkitMatchesSelector,b.matches(a||"*")};return"function"==typeof a&&(b=a),a instanceof u&&(b=function(b){return a.nodes.indexOf(b)!==-1}),u(this.nodes.filter(b))},u.prototype.find=function(a){return this.map(function(b){return u(a||"*",b)})},u.prototype.first=function(){return this.nodes[0]||!1},u.prototype.generate=function(a){return/^\s*<t(h|r|d)/.test(a)?u(document.createElement("table")).html(a).children().nodes:/^\s*</.test(a)?u(document.createElement("div")).html(a).children().nodes:document.createTextNode(a)},u.prototype.handle=function(){var a=this.slice(arguments).map(function(a){return"function"==typeof a?function(b){b.preventDefault(),a.apply(this,arguments)}:a},this);return this.on.apply(this,a)},u.prototype.hasClass=function(){return this.is("."+this.args(arguments).join("."))},u.prototype.html=function(a){return void 0===a?this.first().innerHTML||"":this.each(function(b){b.innerHTML=a})},u.prototype.is=function(a){return this.filter(a).length>0},u.prototype.isInPage=function(a){return a!==document.body&&document.body.contains(a)},u.prototype.last=function(){return this.nodes[this.length-1]||!1},u.prototype.map=function(a){return a?u(this.array(a)).unique():this},u.prototype.not=function(a){return this.filter(function(b){return!u(b).is(a||!0)})},u.prototype.off=function(a){return this.eacharg(a,function(a,b){u(a._e?a._e[b]:[]).each(function(c){a.removeEventListener(b,c)})})},u.prototype.on=function(a,b,c){if("string"==typeof b){var d=b;b=function(a){var b=arguments;u(a.currentTarget).find(d).each(function(d){if(d===a.target||d.contains(a.target)){try{Object.defineProperty(a,"currentTarget",{get:function(){return d}})}catch(e){}c.apply(d,b)}})}}var e=function(a){return b.apply(this,[a].concat(a.detail||[]))};return this.eacharg(a,function(a,b){a.addEventListener(b,e),a._e=a._e||{},a._e[b]=a._e[b]||[],a._e[b].push(e)})},u.prototype.param=function(a){return Object.keys(a).map(function(b){return this.uri(b)+"="+this.uri(a[b])}.bind(this)).join("&")},u.prototype.parent=function(a){return this.map(function(a){return a.parentNode}).filter(a)},u.prototype.prepend=function(a,b){return this.adjacent(a,b,function(a,b){a.insertBefore(b,a.firstChild)})},u.prototype.remove=function(){return this.each(function(a){a.parentNode&&a.parentNode.removeChild(a)})},u.prototype.removeClass=function(){return this.eacharg(arguments,function(a,b){a.classList.remove(b)})},u.prototype.replace=function(a,b){var c=[];return this.adjacent(a,b,function(a,b){c=c.concat(this.slice(b.children)),a.parentNode.replaceChild(b,a)}),u(c)},u.prototype.scroll=function(){return this.first().scrollIntoView({behavior:"smooth"}),this},u.prototype.select=function(a,b){if(a=a.replace(/^\s*/,"").replace(/\s*$/,""),b)return this.select.byCss(a,b);for(var c in this.selectors)if(b=c.split("/"),new RegExp(b[1],b[2]).test(a))return this.selectors[c](a);return this.select.byCss(a)},u.prototype.select.byCss=function(a,b){return(b||document).querySelectorAll(a)},u.prototype.selectors={},u.prototype.selectors[/^\.[\w\-]+$/]=function(a){return document.getElementsByClassName(a.substring(1))},u.prototype.selectors[/^\w+$/]=function(a){return document.getElementsByTagName(a)},u.prototype.selectors[/^\#[\w\-]+$/]=function(a){return document.getElementById(a.substring(1))},u.prototype.selectors[/^</]=function(a){return u().generate(a)},u.prototype.serialize=function(){var a=this;return this.slice(this.first().elements).reduce(function(b,c){return!c.name||c.disabled||"file"===c.type?b:/(checkbox|radio)/.test(c.type)&&!c.checked?b:"select-multiple"===c.type?(u(c.options).each(function(d){d.selected&&(b+="&"+a.uri(c.name)+"="+a.uri(d.value))}),b):b+"&"+a.uri(c.name)+"="+a.uri(c.value)},"").slice(1)},u.prototype.siblings=function(a){return this.parent().children(a).not(this)},u.prototype.size=function(){return this.first().getBoundingClientRect()},u.prototype.slice=function(a){return a&&0!==a.length&&"string"!=typeof a&&"[object Function]"!==a.toString()?a.length?[].slice.call(a.nodes||a):[a]:[]},u.prototype.str=function(a,b){return function(c){return"function"==typeof c?c.call(this,a,b):c.toString()}},u.prototype.text=function(a){return void 0===a?this.first().textContent||"":this.each(function(b){b.textContent=a})},u.prototype.toggleClass=function(a,b){return!!b===b?this[b?"addClass":"removeClass"](a):this.eacharg(a,function(a,b){a.classList.toggle(b)})},u.prototype.trigger=function(a){var b=this.slice(arguments).slice(1);return this.eacharg(a,function(a,c){var d,e={bubbles:!0,cancelable:!0,detail:b};try{d=new window.CustomEvent(c,e)}catch(f){d=document.createEvent("CustomEvent"),d.initCustomEvent(c,!0,!0,b)}a.dispatchEvent(d)})},u.prototype.unique=function(){return u(this.nodes.reduce(function(a,b){var c=null!==b&&void 0!==b&&b!==!1;return c&&a.indexOf(b)===-1?a.concat(b):a},[]))},u.prototype.uri=function(a){return encodeURIComponent(a).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A").replace(/%20/g,"+")},u.prototype.wrap=function(a){function b(a){for(;a.firstElementChild;)a=a.firstElementChild;return u(a)}return this.map(function(c){return u(a).each(function(a){b(a).append(c.cloneNode(!0)),c.parentNode.replaceChild(a,c)})})},"object"==typeof module&&module.exports&&(module.exports={u:u,ajax:ajax});
// Add language tag to the code for print
const regName = /lang(uage)?\-/;
const hasName = name => regName.test(name);
const map = { js: 'javascript', jade: 'pug' };
[].slice.call(document.querySelectorAll('pre code')).forEach(function(pre){
  if (!regName.test(pre.className)) return;
  let name = pre.className.split(/\s+/).filter(hasName)[0].replace(regName, '');
  pre.parentNode.setAttribute('data-language', name in map ? map[name] : name);
});

// Display the proper part in the TOC
u('.toc [href]').filter(el => {
  return u(el).attr('href').split('#')[0] === window.location.pathname;
}).parent().addClass('active');

// Remove an incorrect "get" that there was highlighted
Prism.hooks.add('after-highlight', function(env){
  u('span.token.keyword').each(el => {
    if (el.innerHTML === 'get') {
      if (el.nextElementSibling && el.nextElementSibling.innerHTML === '(') {
        u(el).replace('<span class="token function">get</span>');
      } else {
        u(el).replace('get');
      }
    }
    if (el.innerHTML === 'delete') {
      if (el.previousElementSibling && el.previousElementSibling.innerHTML === '.') {
        u(el).replace('delete');
      }
    }
    if (el.innerHTML === 'public') u(el).replace('public');
  });

  // Syntax highlighting changes vertical align. This makes it to scroll back
  // to the current hash (if any) after page load+highlight
  const hash = window.location.hash;
  if (hash && u(hash).length) {
    u(hash).scroll();
  }
});

// Show more/less when clicking the chevron
u('.toc .more').handle('click', e => {
  const container = u(e.currentTarget).closest('li');
  const child = container.find('ul').nodes[0];
  const height = container.hasClass('active') ? 0 : child.scrollHeight;
  child.style.maxHeight = height + 'px';
  container.toggleClass('active');
});

// Go to the appropriate part of the page when clicking an internal link
u('a').on('click', e => {
  const href = u(e.currentTarget).attr('href');
  if (!href) return;
  const [url, hash] = href.split('#');

  // If it is the current URL just go to the top
  if (url === window.location.pathname && !hash) {
    e.preventDefault();
    u('body').scroll();
    history.replaceState(null, null, window.location.pathname);
    return;
  }

  // If it is an internal link go to that part
  if ((!url || url === window.location.pathname) && u('#' + hash).length) {
    e.preventDefault();
    u('#' + hash).scroll();
    history.replaceState(null, null, '#' + hash);
  }
});



// Google analytics
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-63739359-2', 'auto');
ga('send', 'pageview');


// Hopefully avoid email scrapping
setTimeout(function() {
  u('a.email').attr('href', 'mailto:public' + '@francisco.i' + 'o?subject=server.js');
}, 2000);
</script></body></html>